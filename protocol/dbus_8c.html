<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Whist Protocol: server/dbus.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Whist Protocol
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dbus_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">dbus.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Copyright 2022 Whist Technologies, Inc.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;<a class="el" href="whist_8h_source.html">whist/core/whist.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="logging_8h_source.html">whist/logging/logging.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="log__statistic_8h_source.html">whist/logging/log_statistic.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="command__line_8h_source.html">whist/utils/command_line.h</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="dbus_8h_source.html">dbus.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a277309c7c5573811cd0fd471cc71ceab"><td class="memItemLeft" align="right" valign="top"><a class="el" href="dbus_8h.html#a18df37a209842b7bc4b3ee9800c4cc0b">DBusHandlerContext</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dbus_8c.html#a277309c7c5573811cd0fd471cc71ceab">whist_create_dbus_handler</a> (<a class="el" href="structWhistServerState.html">WhistServerState</a> *<a class="el" href="server_2main_8c.html#af7358ef358d203d67ea84d45ff76c942">server_state</a>)</td></tr>
<tr class="memdesc:a277309c7c5573811cd0fd471cc71ceab"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes a D-Bus handling thread.  <a href="dbus_8c.html#a277309c7c5573811cd0fd471cc71ceab">More...</a><br /></td></tr>
<tr class="separator:a277309c7c5573811cd0fd471cc71ceab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9fd5ebc8a5feb22f5714b50cf03efe42"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dbus_8c.html#a9fd5ebc8a5feb22f5714b50cf03efe42">whist_destroy_dbus_handler</a> (<a class="el" href="dbus_8h.html#a18df37a209842b7bc4b3ee9800c4cc0b">DBusHandlerContext</a> *ctx)</td></tr>
<tr class="memdesc:a9fd5ebc8a5feb22f5714b50cf03efe42"><td class="mdescLeft">&#160;</td><td class="mdescRight">Destroys a D-Bus handling thread by closing connections and freeing memory.  <a href="dbus_8c.html#a9fd5ebc8a5feb22f5714b50cf03efe42">More...</a><br /></td></tr>
<tr class="separator:a9fd5ebc8a5feb22f5714b50cf03efe42"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Copyright 2022 Whist Technologies, Inc. </p>
<p>Contains utilities to capture and handle D-Bus messages.</p>
<hr  />
 <h1><a class="anchor" id="autotoc_md62"></a>
Notes</h1>
<p>Implements logic to connect to an existing D-Bus session, listen for notifications passed through the D-Bus, and send them via the Whist Protocol to the client.</p>
<p>Our approach is to register this application as a D-Bus monitor so that we can snoop on all D-Bus messages and act on the ones we care about. This limits us, as monitors are strictly forbidden from sending messages, and therefore we cannot handle things like notification callbacks and actions.</p>
<p>Also, certain D-Bus messages like Peer messages are automatically handled by D-Bus, which sends replies. Because this violates the no-message rule, D-Bus instantly closes our connection. To avoid this, we currently mark all received D-Bus messages as handled, even though we don't handle them. The medium-term solution is to follow the active pull request associated with <a href="https://gitlab.freedesktop.org/dbus/dbus/-/issues/301">https://gitlab.freedesktop.org/dbus/dbus/-/issues/301</a>.</p>
<p>TODO: We should take a look at <a href="https://codeberg.org/dnkl/fnott">https://codeberg.org/dnkl/fnott</a> and implement our D-Bus interface as a Notification server instead of a Monitor. This will make things more robust and secure, and will allow us to handle things like notification callbacks and actions.</p>
<p>TODO: As I've been working on this file, I've been thinking about how awful the libdbus API is. Strangers on the internet seem to agree with me, and heavily recommend using a higher-level library like GDBus. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a277309c7c5573811cd0fd471cc71ceab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a277309c7c5573811cd0fd471cc71ceab">&#9670;&nbsp;</a></span>whist_create_dbus_handler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="dbus_8h.html#a18df37a209842b7bc4b3ee9800c4cc0b">DBusHandlerContext</a>* whist_create_dbus_handler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structWhistServerState.html">WhistServerState</a> *&#160;</td>
          <td class="paramname"><em>server_state</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes a D-Bus handling thread. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">server_state</td><td>Server state. Must be specified to interface with the Whist protocol.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A reference to the created D-Bus handler context. </dd></dl>

</div>
</div>
<a id="a9fd5ebc8a5feb22f5714b50cf03efe42"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9fd5ebc8a5feb22f5714b50cf03efe42">&#9670;&nbsp;</a></span>whist_destroy_dbus_handler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void whist_destroy_dbus_handler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="dbus_8h.html#a18df37a209842b7bc4b3ee9800c4cc0b">DBusHandlerContext</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Destroys a D-Bus handling thread by closing connections and freeing memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ctx</td><td>A D-Bus handler context to free. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_41e1742e44e2de38b3bc91f993fed282.html">server</a></li><li class="navelem"><a class="el" href="dbus_8c.html">dbus.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
